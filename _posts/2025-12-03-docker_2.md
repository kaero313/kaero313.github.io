---
title: "[도커-2] 다중 컨테이너: 실전 서비스 환경 구성"
date: 2025-12-02 16:30:45 +0900
categories: [Infra, Docker]
tags: [도커, 인프라, 서버]
---

<div align="center">
  <img src="assets/img/docker/icon.png" alt="도커 아이콘" width="500">
</div>

> 사실 고래의 등엔 이미 짊어진 컨테이너가 여러개 있었다. 등에 컨테이너를 더 올려보자.

요즘 같은 시대에 물리적으로 하나의 호스트(서버)에 App, DB, Logging 등 여러 시스템을 다 넣는 경우는 없을 것이다.<br/>
그렇게 한다면 각 프로세스가 서로에게 미치는 영향이 너무 크고, VM을 사용하여 격리한다고 하더라도 <br/>
OS단위로 격리하는 것은 자원 효율성면에서 크게 떨어지기 때문이다.<br/>
도커도 해당 이슈를 완전히 피해갈 수는 없지만, 효율성과 관리성에서 큰 이점을 얻을 수 있다.<br/>
<br/>
MSA 방식이 주류가 되면서, 도커의 활용성은 더욱 높아졌다.<br/>
하나의 큰 애플리케이션을 도메인별로 독립적이고 배포 가능한 여러 개의 작은 서비스로 나누기에 최적화되어있기 때문이다.<br/>
해당 개념을 파악하기 위해 목적에 맞는 서비스 환경을 구성해 볼 것이다.

<br/>

# 도커 컴포즈
---

도커 컴포즈란 단일 호스트 환경에서 여러 개의 도커 컨테이너를 YAML 파일 하나로 정의하고 관리하는 도구이다.<br/>
즉, 위에서 얘기했던 하나의 독립적인 서비스를 만들게 해주는 도구라는 것이다.<br/>

> 그럼 다중 호스트 환경은 어떻게 구성해야 함?

간단하게 도커로 구성한다면 도커 컴포즈를 활용하는 도커 스웜을,<br/>
엔터프라이즈급 대규모 환경이라면 그 유명한 쿠버네티스를 활용해야 한다.<br/>
범위가 너무 커지므로 그건 추후에 다뤄보고, 우선 도커 컴포즈부터 시작하겠다.<br/>

## 컴포즈 사용 방법

사용 방법은 간단하다.<br/>
- 도커 컴포즈 도구를 설치한다.<br/>
  - 도커 엔진 v20.10.0 이상 버전부터는 컴포즈가 자동으로 포함되어있다.
- **docker-compose.yml**이라는 설정 파일을 통해 서비스를 정의하고 관리한다.<br/>

<div align="left">
  <img src="assets/img/docker/compose_version.png" alt="도커 컴포즈 버전 확인" width="500">
</div>

> 도커 엔진 외에 별도로 설치를 안 했는데도 이미 컴포즈 도구가 설치되어있다.

<br/>

# docker-compose.yml 파일 작성하기
---

파일 구조는 크게 보면 최상위 키와 하위 키로 나눌 수 있다.

## 최상위 키

| 최상위 키 | 필수 여부 | 역할 및 설명 | 핵심 하위 키 예시 |
| :--- | :--- | :--- | :--- |
| version | **필수** | 이 설정 파일이 따르는 **Docker Compose 파일 규격(문법) 버전**을 지정한다. | (없음, 값 자체가 버전 정보) |
| services | **필수** | 실제 구동할 **개별 컨테이너(서비스)**를 정의하는 핵심 섹션이다. | build, image, ports, environment, volumes |
| volumes | 선택 | 컨테이너가 삭제되어도 데이터가 유지되도록 **영속적인 저장소**를 정의하는 섹션이다. | driver, external |
| networks | 선택 | 기본 네트워크 대신 **사용자 지정 네트워크**를 정의할 때 사용한다. | driver, external |

- 가장 중요한 섹션: 실제로 대부분의 설정 작업은 services 키 아래에서 이루어지며,<br/>
여기서 build, ports, environment와 같은 다양한 하위 키를 사용하여 컨테이너의 동작을 세밀하게 제어한다.
- 네트워크 생략: networks 섹션을 정의하지 않으면, 컴포즈는 자동으로 기본 네트워크를 생성하고<br/>
services에 정의된 모든 컨테이너를 여기에 연결한다.
- 볼륨 사용: volumes 키는 볼륨 자체를 정의하는 곳이며, 실제로 컨테이너에 볼륨을 연결하는 것은<br/>
services 섹션의 하위 키인 volumes에서 이루어진다.

## 하위 키

여기서는 자주 사용하는 하위 키들만 정리하도록 하겠다.<br/>
정확한 내용을 알고 싶으면 공식 문서를 참조하면 된다.<br/>
- https://docs.docker.com/reference/compose-file/


### services 섹션의 핵심 하위 키

| 하위 키 | 필수 여부 | 역할 및 설명 | 예시 |
| :--- | :--- | :--- | :--- |
| build | 조건부 필수 | 로컬 **Dockerfile**을 써서 이미지를 **빌드**하도록 지정한다. | build: . |
| image | 조건부 필수 | 도커 레지스트리에서 **다운로드할 기존 이미지**를 지정한다. (build 대신 사용). | image: postgres:14-alpine |
| ports | 선택 | **호스트**와 **컨테이너** 포트를 연결(**포트 포워딩**)한다. | ports: - "8080:5000" |
| volumes | 선택 | 컨테이너 내부 경로와 **볼륨** 또는 **호스트 경로**를 연결하여 **데이터 영속성**을 확보한다. | volumes: - db_data:/var/lib/data |
| environment | 선택 | 컨테이너 내부에 주입할 **환경 변수**를 정의한다. (DB 비밀번호, API 키 등). | environment: - DB_HOST=db |
| depends_on | 선택 | 이 서비스가 시작되기 **전에** 완료되어야 할 다른 서비스를 지정한다. (순서 보장). | depends_on: - db |
| networks | 선택 | 서비스가 연결될 **네트워크**를 명시적으로 지정한다. | networks: - backend_net |

<br/>

### volumes 섹션의 핵심 하위 키

| 하위 키 | 필수 여부 | 역할 및 설명 | 예시 |
| :--- | :--- | :--- | :--- |
| (볼륨 이름) | **필수** | 볼륨 정의의 시작점. 사용자가 지정하는 이름이다. | db_data: |
| driver | 선택 | 볼륨을 만들 때 쓸 드라이버를 지정한다. (기본값: local). | driver: local |
| external | 선택 | 이 볼륨이 Compose 외부에 **이미 존재**함을 선언하여 새로 만들지 않도록 한다. | external: true |

<br/>

### networks 섹션의 핵심 하위 키

| 하위 키 | 필수 여부 | 역할 및 설명 | 예시 |
| :--- | :--- | :--- | :--- |
| (네트워크 이름) | **필수** | 네트워크 정의의 시작점. 사용자가 지정하는 이름이다. | backend_net: |
| driver | 선택 | 사용할 네트워크 드라이버를 지정한다. (기본값: bridge). | driver: bridge |
| external | 선택 | 이 네트워크가 Compose 외부에 **이미 존재**함을 선언한다. | external: true |
| ipam | 선택 | **IP 주소 관리** 설정을 통해 서브넷 등을 명시적으로 지정한다. | ipam: {config: [{subnet: '172.20.0.0/16'}]} |

<br/>

