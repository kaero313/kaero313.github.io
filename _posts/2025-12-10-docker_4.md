---
title: "[ë„ì»¤-4] CI/CD ìë™í™”: GitHub Actionsë¥¼ í†µí•œ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œì™€ ìë™ ë°°í¬"
date: 2025-12-10 13:49:31 +0900
categories: [Infra, Docker]
tags: [ë„ì»¤, ì¸í”„ë¼, ì„œë²„]
preview_image: assets/img/docker/prev_icon.png
---

<div align="center">
  <img src="assets/img/docker/github_actions.png" alt="ê¹ƒí—ˆë¸Œ ì•¡ì…˜ ì•„ì´ì½˜" width="500">
</div>

> ì•„ë‹ˆ ë„ì»¤ ì–˜ê¸°ì¤‘ì¸ë° ê°‘ìê¸° ê¹ƒí—ˆë¸Œ ê´€ë ¨í•œê²Œ ì™œ ë‚˜ì˜´ ?

ë„ì»¤ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê¹”ë”í•˜ê²Œ ì»¨í…Œì´ë„ˆí™”í•˜ëŠ” ê²ƒê¹Œì§„ ì„±ê³µí–ˆë‹¤. ê·¸ëŸ°ë° ë¬¸ë“ ê¶ê¸ˆì¦ì´ ìƒê²¼ë‹¤.<br/>
"ë‚´ê°€ ë§Œë“  ì´ ì´ë¯¸ì§€ë¥¼ ì½”ë“œê°€ ë°”ë€” ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ ë¹Œë“œí•˜ê³ , ì„œë²„ì— ì˜¬ë¦¬ëŠ” ê³¼ì •ì€ ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œ?"<br/>
ê²°êµ­ ë„ì»¤ì˜ ê¶ê·¹ì ì¸ ëª©ì , ì¦‰ 'ì–´ë””ì„œë“  ì‰½ê²Œ ì‹¤í–‰ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜'ì„ ì™„ì„±í•˜ë ¤ë©´ ìë™í™” íŒŒì´í”„ë¼ì¸ êµ¬ì¶•ì´ í•„ìˆ˜ì ì´ì—ˆë‹¤.<br/>
Jenkins, GitLab CI/CD, CircleCI, GitHub Actionsë“± ìˆ˜ ë§ì€ CI/CD ë„êµ¬ê°€ ìˆì—ˆëŠ”ë°,<br/>
ì—¬ê¸°ì„œëŠ” GitHub Actionsë¥¼ ì‚¬ìš©í•˜ì—¬ ìë™í™” íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•´ë³´ë„ë¡ í•˜ê² ë‹¤.<br/>
<br/>
ë„ì»¤ê°€ ê²°ê³¼ë¬¼(ì´ë¯¸ì§€)ì„ ë‹´ë‹¹í•œë‹¤ë©´, ì•¡ì…˜ì€ ê³¼ì •(ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ë°°í¬)ì„ ì±…ì„ì§€ëŠ” ì…ˆì´ë‹¤.<br/>
ìµœì¢…ì ì¸ ì›Œí¬ í”Œë¡œìš°ëŠ” ì•„ë˜ì™€ ê°™ì´ ë  ê²ƒì´ë‹¤.

```tree
1. ê°œë°œìê°€ ë¡œì»¬ì—ì„œ ì½”ë“œ ìˆ˜ì •
   â†“
2. ìˆ˜ì • ë‚´ì—­ Git Push
   â†“
3. ìë™ í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ
   â†“
4. ì„±ê³µì‹œ ìë™ ë„ì»¤ í—ˆë¸Œ ì—…ë¡œë“œ
```

# ê¹ƒí—ˆë¸Œ
---

## ë ˆí¬ì§€í† ë¦¬ ìƒì„±

ìš°ì„  ì½”ë“œë¥¼ ì˜¬ë¦´ ìˆ˜ ìˆëŠ” ë ˆí¬ì§€í† ë¦¬ê°€ í•„ìš”í•˜ë‹¤.<br/>
docker_github-actions ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ìƒì„±ì„ í•˜ê³ , ë„ì»¤ì™€ ì—°ë™í•˜ê¸° ìœ„í•´<br/>
ë„ì»¤ í—ˆë¸Œ ì—‘ì„¸ìŠ¤ í† í°ì„ ë°œê¸‰ë°›ì•„ ìœ ì € ì´ë¦„ê³¼ í•¨ê»˜ í•´ë‹¹ ë ˆí¬ì§€í† ë¦¬ secretsì— ë“±ë¡ì„ í–ˆë‹¤.<br/>

<div align="left" style="display:flex;">
  <img src="assets/img/docker/dockerhub_token.png" alt="ë„ì»¤ í—ˆë¸Œ í† í°" width="500">
  <img src="assets/img/docker/repo_secrets.png" alt="ë ˆí¬ ì‹œí¬ë¦¿" width="500">
</div>

## ê¹ƒí—ˆë¸Œ ì•¡ì…˜

ê¹ƒí—ˆë¸Œ ì•¡ì…˜ì˜ ì›Œí¬í”Œë¡œìš°ë¥¼ ì •ì˜í•˜ê³ , ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•˜ëŠ” ê·œì¹™ì€ ë‘ ê°€ì§€ì´ë‹¤.
- ë ˆí¬ì§€í† ë¦¬ ìµœìƒë‹¨ì— í•„ìˆ˜ ë””ë ‰í† ë¦¬ëª… ì§€ì •í•˜ì—¬ ìƒì„±: .github/workflows
- í•´ë‹¹ ë””ë ‰í† ë¦¬ ì•ˆì˜ íŒŒì¼ì€ yaml, yml í¬ë§·ìœ¼ë¡œ ì‘ì„±

ë‹¤ìŒì€ .github/workflows/docker-build.ymlì˜ ë‚´ìš©ì´ë‹¤.
```yml
# ============================================
# Workflow ì´ë¦„ (GitHub Actions íƒ­ì— í‘œì‹œë¨)
# ============================================
name: Docker Build and Push

# ============================================
# íŠ¸ë¦¬ê±°: ì–¸ì œ ì´ workflowë¥¼ ì‹¤í–‰í• ì§€ ì •ì˜
# ============================================
on:
  push:
    branches: [ main ]  # main ë¸Œëœì¹˜ì— push ì‹œ ì‹¤í–‰
    tags:
      - 'v*'           # vë¡œ ì‹œì‘í•˜ëŠ” íƒœê·¸ push ì‹œ ì‹¤í–‰ (ì˜ˆ: v1.0, v2.1)

# ============================================
# Jobs: ì‹¤í–‰í•  ì‘ì—…ë“¤
# ============================================
jobs:
  build:
    # Ubuntu ìµœì‹  ë²„ì „ ê°€ìƒ ë¨¸ì‹ ì—ì„œ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    # ============================================
    # Steps: ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•  ë‹¨ê³„ë“¤
    # ============================================
    steps:
      # ----------------------------------------
      # Step 1: GitHub ì €ì¥ì†Œì—ì„œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      # ----------------------------------------
      - name: Checkout code
        uses: actions/checkout@v3  # GitHub ê³µì‹ ì•¡ì…˜ ì‚¬ìš©
      
      # ----------------------------------------
      # Step 2: ë²„ì „ ì •ë³´ ì¶”ì¶œ
      # íƒœê·¸ pushë©´ íƒœê·¸ ì´ë¦„(v2.1), ì•„ë‹ˆë©´ 'latest'
      # ----------------------------------------
      - name: Get version
        id: version  # ë‹¤ë¥¸ stepì—ì„œ ì°¸ì¡°í•  ID
        run: |
          # GITHUB_REFê°€ refs/tags/ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # refs/tags/v2.1 â†’ v2.1 ì¶”ì¶œ
            VERSION=${GITHUB_REF#refs/tags/}
            # ì¶œë ¥ ë³€ìˆ˜ ì„¤ì • (ë‹¤ë¥¸ stepì—ì„œ ì‚¬ìš©)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            # íƒœê·¸ê°€ ì•„ë‹ˆë©´ latest
            echo "version=latest" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi
      
      # ----------------------------------------
      # Step 3: Docker Hub ë¡œê·¸ì¸
      # GitHub Secretsì— ì €ì¥ëœ ì¸ì¦ ì •ë³´ ì‚¬ìš©
      # ----------------------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v2  # Docker ê³µì‹ ë¡œê·¸ì¸ ì•¡ì…˜
        with:
          # Settings â†’ Secretsì— ì €ì¥ëœ ê°’ ì‚¬ìš©
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      # ----------------------------------------
      # Step 4: Docker ì´ë¯¸ì§€ ë¹Œë“œ
      # í•­ìƒ latest ë¹Œë“œ, ë¦´ë¦¬ìŠ¤ë©´ ë²„ì „ íƒœê·¸ë„ ë¹Œë“œ
      # ----------------------------------------
      - name: Build Docker image
        run: |
          # latest íƒœê·¸ëŠ” í•­ìƒ ë¹Œë“œ
          docker build -t nayatrei3/nayatrei-app:latest ./app
          
          # ë¦´ë¦¬ìŠ¤(íƒœê·¸ push)ì¸ ê²½ìš°ì—ë§Œ ë²„ì „ íƒœê·¸ ì¶”ê°€ ë¹Œë“œ
          if [[ "${{ steps.version.outputs.is_release }}" == "true" ]]; then
            # ì˜ˆ: nayatrei3/nayatrei-app:v2.1
            docker build -t nayatrei3/nayatrei-app:${{ steps.version.outputs.version }} ./app
          fi
      
      # ----------------------------------------
      # Step 5: Docker Hubì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
      # ë¹Œë“œí•œ ì´ë¯¸ì§€ë“¤ì„ Docker Hubì— push
      # ----------------------------------------
      - name: Push to Docker Hub
        run: |
          # latest íƒœê·¸ëŠ” í•­ìƒ push
          docker push nayatrei3/nayatrei-app:latest
          
          # ë¦´ë¦¬ìŠ¤ì¸ ê²½ìš°ì—ë§Œ ë²„ì „ íƒœê·¸ë„ push
          if [[ "${{ steps.version.outputs.is_release }}" == "true" ]]; then
            # ì˜ˆ: nayatrei3/nayatrei-app:v2.1
            docker push nayatrei3/nayatrei-app:${{ steps.version.outputs.version }}
          fi
      
      # ----------------------------------------
      # Step 6: ê²°ê³¼ ì¶œë ¥ (ë¡œê·¸ì— í‘œì‹œ)
      # ì–´ë–¤ ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸ìš©
      # ----------------------------------------
      - name: Image info
        run: |
          # latestëŠ” í•­ìƒ ì¶œë ¥
          echo "Pushed: nayatrei3/nayatrei-app:latest"
          
          # ë¦´ë¦¬ìŠ¤ì¸ ê²½ìš° ë²„ì „ íƒœê·¸ë„ ì¶œë ¥
          if [[ "${{ steps.version.outputs.is_release }}" == "true" ]]; then
            echo "Pushed: nayatrei3/nayatrei-app:${{ steps.version.outputs.version }}"
          fi

# ============================================
# ì „ì²´ íë¦„ ìš”ì•½:
# 1. main push â†’ latestë§Œ ë¹Œë“œ/ì—…ë¡œë“œ
# 2. v2.1 tag push â†’ latest + v2.1 ë¹Œë“œ/ì—…ë¡œë“œ
# ============================================
```

- [ê¹ƒí—ˆë¸Œ ì•¡ì…˜ ë¬¸ì„œ](https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax)

íŒŒì¼ì€ ê¸°ë³¸ì ìœ¼ë¡œ yamlí˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë©°, ë‚´ìš©ì€ ê¹ƒí—ˆë¸Œ ì•¡ì…˜ì—ì„œ ì •ì˜í•œ ê³ ìœ ì˜ ë¬¸ë²•ì„ ë”°ë¥¸ë‹¤.<br/>
ì •í™•íˆ ë¬´ìŠ¨ ê¸°ëŠ¥ì¸ì§€ëŠ” ëª¨ë¥´ì§€ë§Œ í‚¤ì›Œë“œë¥¼ ë³´ê³  ìœ ì¶”í•˜ê¸°ì—ëŠ” ì¶©ë¶„í•˜ë‹¤.
> ëª¨ë¥´ë©´ ê·¸ëƒ¥ ëŠê»´

<br/>

# CI/CD ìë™í™”
---

## íƒœê·¸ ë²„ì „ê´€ë¦¬ ìë™í™”

ê°œë°œìê°€ ê°œë°œì„ í•˜ê²Œ ë˜ë©´ í•˜ë£¨ì—ë„ ëª‡ ë²ˆì”© ê¹ƒ ì €ì¥ì†Œì— ì˜¬ë¦´ ì¼ì´ ìƒê¸°ëŠ”ë°,<br/>
ê·¸ì— ë”°ë¼ ìƒê¸°ëŠ” ëª¨ë“  ì´ë¯¸ì§€ë¥¼ ë„ì»¤ í—ˆë¸Œì— íƒœê·¸ë¥¼ ì§€ì •í•˜ì—¬ ì˜¬ë¦´ í•„ìš”ëŠ” ì—†ì„ ê²ƒì´ë‹¤.<br/>
íŠ¹ì • ì‹œì ì˜ ë²„ì „ë§Œ íƒœê·¸ë¥¼ ë”°ì„œ ì˜¬ë¦¬ë©´ ì¶©ë¶„í•˜ê¸°ì— ë§¤ë²ˆ ë®ì–´ì”Œì›Œì§€ëŠ” ë§ˆì§€ë§‰ ì´ë¯¸ì§€ë¥¼ ì•Œë¦¬ëŠ” latest íƒœê·¸ì™€,<br/>
v2.1ì²˜ëŸ¼ ë”°ë¡œ ë„˜ë²„ë§í•´ì„œ ì˜¬ë¦¬ê³  ê´€ë¦¬í•˜ëŠ” íƒœê·¸ ë‘ ê°€ì§€ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ì›Œí¬ í”Œë¡œìš° íŒŒì¼ì„ ì‘ì„±í–ˆì—ˆë‹¤.<br/> 
ì¤€ë¹„ëŠ” ë˜ì—ˆìœ¼ë‹ˆ ì´ì œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ ë³´ê² ë‹¤.

<div align="left" style="display:flex;">
  <img src="assets/img/docker/github-actions_push.png" alt="ê¹ƒ ì €ì¥ì†Œ í‘¸ì‰¬" width="500">
  <img src="assets/img/docker/dockerhub_tag.png" alt="ë„ì»¤ ì €ì¥ì†Œ í‘¸ì‰¬" width="500">
</div>
> daily updateì— ë¹„í•´, weekly updateëŠ” íƒœê·¸ë¥¼ ìƒì„±í•˜ëŠ” ì ˆì°¨ê°€ ë” ì¡´ì¬í•œë‹¤.

ë§¤ì¼ í•˜ëŠ” ì—…ë°ì´íŠ¸ëŠ” ë”°ë¡œ ë²„ì „ ê´€ë¦¬ ì—†ì´ ë§ˆì§€ë§‰ ì´ë¯¸ì§€ë§Œ ì €ì¥í•˜ê³ ,<br/>
ì£¼ì— 1ë²ˆ í•˜ëŠ” ì—…ë°ì´íŠ¸ëŠ” ë²„ì „ ëª…ì„ ì§€ì •í•´ì„œ ë”°ë¡œ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ëŠ” ë°©ì‹ì´ë‹¤.<br/>

### ê° êµ¬ë¬¸ë³„ í•´ì„

- `git push origin main`
  - main ë¸Œëœì¹˜ì˜ ìµœì‹  ìƒíƒœë¥¼ GitHubì— ì—…ë¡œë“œí•œë‹¤.
- `git tag v2.1`
  - í˜„ì¬ ì»¤ë°‹ì— v2.1ì´ë¼ëŠ” íƒœê·¸ë¥¼ ë¶™ì¸ë‹¤.
- `git push origin v2.1`
  - v2.1 íƒœê·¸ë¥¼ GitHubì— ì—…ë¡œë“œí•œë‹¤.

## ë¹Œë“œ í…ŒìŠ¤íŠ¸ ìë™í™”

í˜„ì¬ ìƒíƒœì—ì„œëŠ” ê¹ƒì— í‘¸ì‰¬í•˜ë©´ ìë™ìœ¼ë¡œ ë„ì»¤ í—ˆë¸Œ ì €ì¥ì†Œê¹Œì§€ ë°˜ì˜ì´ ë˜ëŠ”ë°,<br/>
ë¹Œë“œê°€ ì‹¤íŒ¨í•˜ëŠ” ì˜ëª»ëœ ì½”ë“œê°€ ì˜¬ë¼ê°„ë‹¤ë©´ ë¬¸ì œê°€ ìƒê¸¸ ê²ƒ ì´ë‹¤.<br/>
ë¬¼ë¡  ê°œë°œìê°€ ì• ì´ˆì— ê¹ƒì— ë¹Œë“œê°€ ì‹¤íŒ¨í•˜ëŠ” ì½”ë“œë¥¼ ì˜¬ë¦´ ê²½ìš°ëŠ” ê±°ì˜ ì—†ê² ì§€ë§Œ,<br/>
ë¡œì»¬ í™˜ê²½ê³¼ ìš´ì˜ í™˜ê²½ì˜ ì°¨ì´ì—ì„œ ì˜¤ëŠ” ë¬¸ì œë¡œ ìƒê¸¸ ê°€ëŠ¥ì„±ì€ ì¶©ë¶„íˆ ì˜ˆì¸¡í•  ìˆ˜ ìˆë‹¤.<br/>
ê·¸ëŸ¬ë¯€ë¡œ í˜¹ì‹œ ëª¨ë¥¼ ìƒí™©ì— ëŒ€ë¹„í•˜ì—¬, ê¹ƒì— í‘¸ì‰¬ê°€ ë˜ë©´ ìë™ìœ¼ë¡œ ë¹Œë“œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê³  
ì„±ê³µí–ˆì„ë•Œë§Œ ë„ì»¤ í—ˆë¸Œì— ë°°í¬í•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•´ë³´ê² ë‹¤.<br/>

### ì˜ˆìƒ ì‹¤í–‰ íë¦„

<div align="center">
  <img src="assets/img/docker/ci_cd_flow.png" alt="ci/cd íë¦„" width="650">
</div>
> ì„  ë¹Œë“œ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ì—¬ ì„±ê³µí–ˆì„ ê²½ìš°ì—ë§Œ ë¹Œë“œí•˜ì—¬ ë„ì»¤ í—ˆë¸Œì— ì—…ë¡œë“œë¥¼ í•œë‹¤.

- í•µì‹¬: ë²„ê·¸ ìˆëŠ” ì½”ë“œëŠ” ë°°í¬ í•˜ì§€ ì•ŠëŠ”ë‹¤.

### í…ŒìŠ¤íŠ¸ íŒŒì¼ ì‘ì„±

ì„±ê³µ/ì‹¤íŒ¨ ì¼€ì´ìŠ¤ íŒŒì¼ì„ ë”°ë¡œ ë§Œë“œëŠ”ê²Œ í…ŒìŠ¤íŠ¸í•˜ê¸°ì— í¸í•˜ê¸°ì— í…ŒìŠ¤íŠ¸ìš© íŒŒì¼ì„ ì¤€ë¹„í–ˆë‹¤.

- íŒŒì´ì¬ ì•±(/docker_github-actions/app/test/test_app.py)

```python
# test/test_app.py
import pytest
import sys
import os

# app.pyë¥¼ importí•  ìˆ˜ ìˆë„ë¡ ê²½ë¡œ ì¶”ê°€
sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))

from app import app

@pytest.fixture
def client():
    """Flask í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ ìƒì„±"""
    app.config['TESTING'] = True
    with app.test_client() as client:
        yield client

def test_home(client):
    """ë©”ì¸ í˜ì´ì§€ í…ŒìŠ¤íŠ¸"""
    response = client.get('/')
    assert response.status_code == 200
    data = response.get_json()
    assert 'message' in data
    assert 'status' in data
    assert data['status'] == 'running'

def test_home_message_content(client):
    """ë©”ì‹œì§€ ë‚´ìš© í™•ì¸"""
    response = client.get('/')
    data = response.get_json()
    assert 'Hello' in data['message'] or 'CI/CD' in data['message']

def test_response_format(client):
    """ì‘ë‹µ í˜•ì‹ ê²€ì¦"""
    response = client.get('/')
    assert response.content_type == 'application/json'
```

<br/>

- requirements.txt(/docker_github-actions/app/requirements.txt)

ê¸°ì¡´ íŒŒì¼ì— íŒŒì´ì¬ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ `pytest==7.4.3` ì¶”ê°€

<br/>

- \__init__.py(/docker_github-actions/app/test/\__init__.py)

test ë””ë ‰í† ë¦¬ë¥¼ íŒŒì´ì¬ íŒ¨í‚¤ì§€ë¡œ ì¸ì‹ì‹œí‚¤ê¸° ìœ„í•œ ë¹ˆ init íŒŒì¼ ìƒì„±

#### ë¹Œë“œ í…ŒìŠ¤íŠ¸

```linux
pip install pytest

cd /docker_github-actions/app
pytest test/ -v
```

<div align="left">
  <img src="assets/img/docker/pytest.png" alt="pytest" width="500">
</div>
> ì‹¤í–‰ ì „ pip install -r requirements.txt ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í–ˆë‹¤.

#### ì›Œí¬í”Œë¡œìš° íŒŒì¼ì— ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì¶”ê°€

ì›Œí¬í”Œë¡œìš°(/docker_github-actions/.github/workflows/docker-build.yml)

```yml
# ============================================
# Workflow ì´ë¦„ (GitHub Actions íƒ­ì— í‘œì‹œë¨)
# ============================================
name: Docker Build and Push

# ============================================
# íŠ¸ë¦¬ê±°: ì–¸ì œ ì´ workflowë¥¼ ì‹¤í–‰í• ì§€ ì •ì˜
# ============================================
on:
  push:
    branches: [ main ]  # main ë¸Œëœì¹˜ì— push ì‹œ ì‹¤í–‰
    tags:
      - 'v*'           # vë¡œ ì‹œì‘í•˜ëŠ” íƒœê·¸ push ì‹œ ì‹¤í–‰ (ì˜ˆ: v1.0, v2.1)

# ============================================
# Jobs: ì‹¤í–‰í•  ì‘ì—…ë“¤
# ============================================
jobs:
  # ============================================
  # Job 1: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ìƒˆë¡œ ì¶”ê°€)
  # ============================================
  test:
    # Ubuntu ìµœì‹  ë²„ì „ ê°€ìƒ ë¨¸ì‹ ì—ì„œ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    steps:
      # ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout code
        uses: actions/checkout@v3
      
      # Python í™˜ê²½ ì„¤ì • (ìƒˆë¡œ ì¶”ê°€)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      # ì˜ì¡´ì„± ì„¤ì¹˜ (ìƒˆë¡œ ì¶”ê°€)
      - name: Install dependencies
        run: |
          cd app
          pip install -r requirements.txt
      
      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ìƒˆë¡œ ì¶”ê°€)
      - name: Run tests
        run: |
          cd app
          pytest tests/ -v --tb=short
      
      # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ (ìƒˆë¡œ ì¶”ê°€)
      - name: Test summary
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "All tests passed!"
          else
            echo "Tests failed!"
            exit 1
          fi

  # ============================================
  # Job 2: Docker ë¹Œë“œ & ë°°í¬
  # ============================================
  build:
    needs: test  # test jobì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰ (ì¶”ê°€ë¨)
    # Ubuntu ìµœì‹  ë²„ì „ ê°€ìƒ ë¨¸ì‹ ì—ì„œ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    # ============================================
    # Steps: ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•  ë‹¨ê³„ë“¤
    # ============================================
    steps:
      # ----------------------------------------
      # Step 1: GitHub ì €ì¥ì†Œì—ì„œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      # ----------------------------------------
      - name: Checkout code
        uses: actions/checkout@v3  # GitHub ê³µì‹ ì•¡ì…˜ ì‚¬ìš©
      
      # ----------------------------------------
      # Step 2: ë²„ì „ ì •ë³´ ì¶”ì¶œ
      # íƒœê·¸ pushë©´ íƒœê·¸ ì´ë¦„(v2.1), ì•„ë‹ˆë©´ 'latest'
      # ----------------------------------------
      - name: Get version
        id: version  # ë‹¤ë¥¸ stepì—ì„œ ì°¸ì¡°í•  ID
        run: |
          # GITHUB_REFê°€ refs/tags/ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # refs/tags/v2.1 â†’ v2.1 ì¶”ì¶œ
            VERSION=${GITHUB_REF#refs/tags/}
            # ì¶œë ¥ ë³€ìˆ˜ ì„¤ì • (ë‹¤ë¥¸ stepì—ì„œ ì‚¬ìš©)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            # íƒœê·¸ê°€ ì•„ë‹ˆë©´ latest
            echo "version=latest" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi
      
      # ----------------------------------------
      # Step 3: Docker Hub ë¡œê·¸ì¸
      # GitHub Secretsì— ì €ì¥ëœ ì¸ì¦ ì •ë³´ ì‚¬ìš©
      # ----------------------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v2  # Docker ê³µì‹ ë¡œê·¸ì¸ ì•¡ì…˜
        with:
          # Settings â†’ Secretsì— ì €ì¥ëœ ê°’ ì‚¬ìš©
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      # ----------------------------------------
      # Step 4: Docker ì´ë¯¸ì§€ ë¹Œë“œ
      # í•­ìƒ latest ë¹Œë“œ, ë¦´ë¦¬ìŠ¤ë©´ ë²„ì „ íƒœê·¸ë„ ë¹Œë“œ
      # ----------------------------------------
      - name: Build Docker image
        run: |
          # latest íƒœê·¸ëŠ” í•­ìƒ ë¹Œë“œ
          docker build -t nayatrei3/nayatrei-app:latest ./app
          
          # ë¦´ë¦¬ìŠ¤(íƒœê·¸ push)ì¸ ê²½ìš°ì—ë§Œ ë²„ì „ íƒœê·¸ ì¶”ê°€ ë¹Œë“œ
          if [[ "${{ steps.version.outputs.is_release }}" == "true" ]]; then
            # ì˜ˆ: nayatrei3/nayatrei-app:v2.1
            docker build -t nayatrei3/nayatrei-app:${{ steps.version.outputs.version }} ./app
          fi
      
      # ----------------------------------------
      # Step 5: Docker Hubì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
      # ë¹Œë“œí•œ ì´ë¯¸ì§€ë“¤ì„ Docker Hubì— push
      # ----------------------------------------
      - name: Push to Docker Hub
        run: |
          # latest íƒœê·¸ëŠ” í•­ìƒ push
          docker push nayatrei3/nayatrei-app:latest
          
          # ë¦´ë¦¬ìŠ¤ì¸ ê²½ìš°ì—ë§Œ ë²„ì „ íƒœê·¸ë„ push
          if [[ "${{ steps.version.outputs.is_release }}" == "true" ]]; then
            # ì˜ˆ: nayatrei3/nayatrei-app:v2.1
            docker push nayatrei3/nayatrei-app:${{ steps.version.outputs.version }}
          fi
      
      # ----------------------------------------
      # Step 6: ê²°ê³¼ ì¶œë ¥ (ë¡œê·¸ì— í‘œì‹œ)
      # ì–´ë–¤ ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸ìš©
      # ----------------------------------------
      - name: Image info
        run: |
          # latestëŠ” í•­ìƒ ì¶œë ¥
          echo "Pushed: nayatrei3/nayatrei-app:latest"
          
          # ë¦´ë¦¬ìŠ¤ì¸ ê²½ìš° ë²„ì „ íƒœê·¸ë„ ì¶œë ¥
          if [[ "${{ steps.version.outputs.is_release }}" == "true" ]]; then
            echo "Pushed: nayatrei3/nayatrei-app:${{ steps.version.outputs.version }}"
          fi

# ============================================
# ì „ì²´ íë¦„ ìš”ì•½:
# 1. main push â†’ test ì‹¤í–‰ â†’ (ì„±ê³µ) build ì‹¤í–‰ (ìƒˆë¡œ ì¶”ê°€)
# 2. v2.1 tag push â†’ test ì‹¤í–‰ â†’ (ì„±ê³µ) build ì‹¤í–‰ (ìƒˆë¡œ ì¶”ê°€)
# 3. í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ â†’ build ì‹¤í–‰ ì•ˆ ë¨ (ìƒˆë¡œ ì¶”ê°€)
# ============================================
```
> ë¹Œë“œ í…ŒìŠ¤íŠ¸ ê´€ë ¨í•˜ì—¬ ìƒˆë¡œ ì¶”ê°€ëœ ë¶€ë¶„ì„ í‘œì‹œí–ˆë‹¤.

### push í…ŒìŠ¤íŠ¸

ìˆ˜ì • ë‚´ì—­ì´ ê¹ƒì— ì˜¬ë¼ê°€ë©´ ë¨¼ì € ë¹Œë“œ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ì—¬ ì„±ê³µì‹œì—ë§Œ
ë„ì»¤ í—ˆë¸Œì— ì—…ë¡œë“œí•˜ëŠ” ë¡œì§ì„ ì¶”ê°€í•˜ì˜€ìœ¼ë‹ˆ ì •ìƒ ì‘ë™ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ê² ë‹¤.

<div align="left" style="display:flex;">
  <img src="assets/img/docker/auto_build_test1.png" alt="auto_build_test1" width="500">
  <img src="assets/img/docker/auto_build_test2.png" alt="auto_build_test2" width="500">
</div>
> ê¹ƒ í† í°ì— workflow ê¶Œí•œì„ ì¶”ê°€í•´ì¤˜ì•¼ ì •ìƒì ìœ¼ë¡œ pushê°€ ê°€ëŠ¥í•´ì§„ë‹¤.

<div align="left" style="display:flex;">
  <img src="assets/img/docker/auto_build_test3.png" alt="auto_build_test3" width="500">
  <img src="assets/img/docker/auto_build_test4.png" alt="auto_build_test4" width="500">
</div>
> ê¹ƒí—ˆë¸Œ ì•¡ì…˜ì—ì„œ ë¨¼ì € í…ŒìŠ¤íŠ¸, ë¹Œë“œë¥¼ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰ í›„ ë„ì»¤ í—ˆë¸Œì— ì´ë¯¸ì§€ ì—…ë¡œë“œê°€ ë˜ì—ˆë‹¤.

#### ë¹Œë“œ ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸

í…ŒìŠ¤íŠ¸ìš© íŒŒì´ì¬ ì•± íŒŒì¼(/docker_github-actions/app/test/test_app.py)ì˜ ë§¨ ëì— ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸ìš© ë¡œì§ì„ ì¶”ê°€í–ˆë‹¤.

```python
def test_should_fail():
    """ì¼ë¶€ëŸ¬ ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸"""
    assert 1 == 2  # ë¬´ì¡°ê±´ ì‹¤íŒ¨!
```

<div align="left">
  <img src="assets/img/docker/build_fail_test.png" alt="build_fail_test" width="700">
</div>
> ê¹ƒí—ˆë¸Œ ì•¡ì…˜ì—ì„œ ë¹Œë“œë¥¼ ì‹¤íŒ¨í•˜ë‹ˆ, ë„ì»¤ í—ˆë¸Œì—ëŠ” ì´ë¯¸ì§€ ì—…ë¡œë“œê°€ ë˜ì§€ ì•Šì•˜ë‹¤.

ì´ì œ ë¹Œë“œ ì„±ê³µ ìœ ë¬´ì— ë”°ë¥¸ ë„ì»¤ í—ˆë¸Œ ì—…ë¡œë“œ ìë™í™”ê¹Œì§€ ì ìš©í•˜ì˜€ë‹¤. <br/>
ì²˜ìŒ ëª©í‘œëŠ” ì—¬ê¸°ê¹Œì§€ì˜€ì§€ë§Œ í˜„ì¬ ìƒíƒœì—ì„œëŠ” ë¹Œë“œ ë° ì—…ë¡œë“œ ì´í›„ ì„œë²„ ë°°í¬ëŠ” ìˆ˜ë™ìœ¼ë¡œ í•´ì•¼ í•˜ëŠ” ìƒí™©ì´ê¸° ë•Œë¬¸ì—,<br/>
ì¢€ ë” ìë™í™”ì˜ ì˜ë¯¸ì— ë§ìœ¼ë ¤ë©´ ì„œë²„ ë°°í¬ ìë™í™”ê¹Œì§€ êµ¬ì¶•í•˜ëŠ”ê²Œ ë§ë‹¤ê³  ìƒê°í•˜ì—¬ í•´ë‹¹ í•­ëª©ê¹Œì§€ ì§„í–‰í•´ë³´ë„ë¡ í•˜ê² ë‹¤.

## ì„œë²„ ë°°í¬ ìë™í™”

ë„ì»¤ í—ˆë¸Œ ì—…ë¡œë“œ ì´í›„ ì„œë²„ ë°°í¬ê¹Œì§€ ìë™í™”í•œë‹¤ë©´ êµ¬ì„±ëœ ìµœì¢… CI/CD íŒŒì´í”„ë¼ì¸ì€ ì•„ë˜ì™€ ê°™ì´ ë  ê²ƒì´ë‹¤.

```tree
1. ê°œë°œìê°€ ë¡œì»¬ì—ì„œ ì½”ë“œ ìˆ˜ì •
   â†“
2. ìˆ˜ì • ë‚´ì—­ Git Push
   â†“
3. ìë™ í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ
   â†“
4. ì„±ê³µì‹œ ìë™ ë„ì»¤ í—ˆë¸Œ ì—…ë¡œë“œ
   â†“
5. ì„œë²„ ìë™ ë°°í¬
```

ì„œë²„ ìë™ ë°°í¬ ê³¼ì •ì€ ê°„ë‹¨í•˜ê²Œ ìš”ì•½í•˜ë©´ ì„œë²„ ì ‘ì† -> ë„ì»¤ í—ˆë¸Œ ì´ë¯¸ì§€ pull -> ë„ì»¤ ì„œë²„ restartê°€ ëœë‹¤.

### SSH í‚¤ ìƒì„±

ê¹ƒí—ˆë¸Œ ì•¡ì…˜ì´ ì„œë²„ì— ì ‘ì†í•˜ë ¤ë©´ í‚¤ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•˜ë‹¤. <br/>
ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•˜ëŠ”ê²Œ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ë¹„ë°€ë²ˆí˜¸ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤. <br/>
ê·¸ëŸ° ì´ìœ ë¡œ ìë™í™”ì— ìš©ì´í•˜ë©°, ë³´ì•ˆì„±ë„ ë” ë†’ì€ SSHí‚¤ë¥¼ ì´ìš©í•˜ë„ë¡ í•˜ê² ë‹¤.

<div align="left">
  <img src="assets/img/docker/ssh.png" alt="ssh" width="700">
</div>

#### ê° êµ¬ë¬¸ë³„ í•´ì„

- `ssh-keygen -t ed25519 -C "github-actions" -f ~/.ssh/github_actions -N ""`
  - SSHí‚¤ë¥¼ ìƒì„±í•œë‹¤.
    - í˜„ëŒ€ì ì¸ ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜ ed25519ë¥¼ ì„ íƒí•œë‹¤.
    - í‚¤ íŒŒì¼ ëì— ë¶™ëŠ” ì‹ë³„ìš© ë¼ë²¨ì„ github-actionsë¡œ ì§€ì •í•œë‹¤.
    - í‚¤ë¥¼ ì €ì¥í•  ìœ„ì¹˜ì™€ íŒŒì¼ ì´ë¦„ì„ ~/.ssh/github_actionsë¡œ ì§€ì •í•œë‹¤.
    - í‚¤ë¥¼ ì‚¬ìš©í• ë•Œ ì…ë ¥í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ""(ì—†ìŒ)ìœ¼ë¡œ ì„¤ì •í•œë‹¤.
- `github_actions`
  - ê¹ƒí—ˆë¸Œ ì•¡ì…˜ì´ ì†Œìœ í•  ê°œì¸í‚¤.
- `github_actions.pub`
  - ì„œë²„ì— ë“±ë¡í•  ê³µê°œí‚¤.
- `cat ~/.ssh/github_actions.pub >> ~/.ssh/authorized_keys`
  - ê³µê°œí‚¤ë¥¼ authorized_keysì— ì¶”ê°€í•œë‹¤.
    - ì¶”í›„ ì„œë²„ì— ì ‘ê·¼ì‹œ í•´ë‹¹ íŒŒì¼ì„ í™•ì¸í•˜ì—¬ ì ‘ì†ì´ í—ˆìš©ëœ ê³µê°œí‚¤ì¸ì§€ í™•ì¸í•˜ëŠ” ìš©ë„ì´ë‹¤.
    - ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” ê³µê°œí‚¤ë¼ë©´ ê°œì¸í‚¤ë¥¼ ê²€ì‚¬í•˜ì—¬ ì¼ì¹˜í•˜ë©´ í†µê³¼ì‹œí‚¨ë‹¤.
- `chmod 600 ~/.ssh/authorized_keys`
  - authorized_keys íŒŒì¼ì— ê¶Œí•œì„ ì„¤ì •í•œë‹¤.
    - ì†Œìœ ì(ë³¸ì¸)ë§Œì´ ì½ê¸°+ì“°ê¸°ê°€ ê°€ëŠ¥í•˜ë‹¤.
- `chmod 700 ~/.ssh`
  - .ssh ë””ë ‰í† ë¦¬ì— ê¶Œí•œì„ ì„¤ì •í•œë‹¤.
    - ì†Œìœ ì(ë³¸ì¸)ë§Œì´ ì½ê¸°+ì“°ê¸°+ì‹¤í–‰ì´ ê°€ëŠ¥í•˜ë‹¤.
- `cat ~/.ssh/github_actions`
  - ë“±ë¡í•œ ê°œì¸í‚¤ë¥¼ ì¶œë ¥í•œë‹¤.(ë³µì‚¬í•˜ì—¬ ê¹ƒì— ì €ì¥í•  ìš©ë„) 

### ê¹ƒí—ˆë¸Œì— í‚¤ ë“±ë¡

<div align="left">
  <img src="assets/img/docker/ssh_git.png" alt="ssh_git" width="600">
</div>
> ê¹ƒí—ˆë¸Œ ì„¤ì •ì˜ secrets and variables>Actions ì—ì„œ í‚¤ë¥¼ ë“±ë¡í–ˆë‹¤.

- SERVER_HOST: ì ‘ì†í•  ë„ì»¤ ì„œë²„ì˜ ipì£¼ì†Œ
- SERVER_SSH_KEY: ë³µì‚¬í•œ ê°œì¸í‚¤
- SERVER_USER: SSH ì‚¬ìš©ìëª…

### ì„œë²„ì— ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„

1. /app ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•œë‹¤.
2. /nayatrei-docker-compose/docker-compose.ymlì„ /appì— ë³µì‚¬í•œë‹¤.
3. ë³µì‚¬í•œ íŒŒì¼ì„ ì—´ì–´ ìˆ˜ì •í•œë‹¤.
```yaml
services: 
  app: 
    # build: ./app  â† ì£¼ì„ ì²˜ë¦¬ ë˜ëŠ” ì‚­ì œ
    image: nayatrei3/nayatrei-app:latest  # â† ì¶”ê°€
```

### Workflowì— ë°°í¬ ì¶”ê°€

/docker_github-actions/.github/workflows/docker-build.yml íŒŒì¼ì„ ì—´ì–´ ë§¨ ëì— deploy jobì„ ì¶”ê°€í•œë‹¤.

```yaml
# ============================================
  # Job 3: ì„œë²„ ìë™ ë°°í¬ 
  # ============================================
  deploy:
    needs: build  # build ì„±ê³µ í›„ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    steps:
      # ----------------------------------------
      # Step 1: ì„œë²„ì— SSH ì ‘ì† ë° ë°°í¬
      # ----------------------------------------
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/app
            
            # ìµœì‹  ì´ë¯¸ì§€ ë°›ê¸°
            echo "Pulling latest image..."
            docker pull nayatrei3/nayatrei-app:latest
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            echo "Stopping containers..."
            docker-compose down
            
            # ìƒˆ ì´ë¯¸ì§€ë¡œ ì‹œì‘
            echo "Starting new containers..."
            docker-compose up -d
            
            # ìƒíƒœ í™•ì¸
            echo "Checking status..."
            docker-compose ps
            
            echo "Deployment completed!"
      
      # ----------------------------------------
      # Step 2: ë°°í¬ ê²°ê³¼ ì¶œë ¥
      # ----------------------------------------
      - name: Deployment summary
        run: |
          echo "Deployed to: ${{ secrets.SERVER_HOST }}"
          echo "User: ${{ secrets.SERVER_USER }}"
          echo "Image: nayatrei3/nayatrei-app:latest"
```